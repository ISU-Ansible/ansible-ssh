---
- hosts: localhost
  remote_user: root

  roles:
    - role_under_test

  tasks:
    - name: "[Test] User creation for ssh testing"
      user:
        name: "test"
        comment: "Test User"
        password: "$6$5uEBGSA8qzcdnCuG$46D.sd.zdW4kM0Q2wnr0TQk0nY4.rvJ2fk9Oew4ZIt0XbJFpvGnRIR/SOiY1r.qGbqzYmwAery69t0Hh8JwHN0"

    - name: "[Test] Is SSHD running?"
      shell: service sshd status
      register: sshd_el_status
      when: ansible_distribution == 'CentOS'

    - name: "[Test] Is SSHD running?"
      shell: systemctl status sshd.service
      register: sshd_fedora_status
      when: ansible_distribution == 'Fedora'

    - name: "[Test] Is the base configuration in place?"
      shell: grep "PermitRootLogin" /etc/ssh/sshd_config
      register: sshd_configuration

#    - debug:
#        var: sshd_configuration

    - assert:
        that:
         - "sshd_el_status.stdout.find('running')"
         - "sshd_configuration.stdout.find('without-password')"
      when: ansible_distribution == "CentOS"

    - assert:
        that:
         - "sshd_fedora_status.stdout.find('running')"
         - "sshd_configuration.stdout.find('without-password')"
      when: ansible_distribution == "Fedora"
